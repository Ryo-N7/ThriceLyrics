---
title: "Part_3.r"
author: "Ryo Nakagawara"
date: "Fri Oct 13 21:31:45 2017"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r include = FALSE }
library(stringr)

library(tidyverse)
library(tidytext)
library(lubridate)

library(ggrepel)
library(scales)
library(gplots)
library(gridExtra)

library(wordcloud)

# load dataset ------------------------------------------------------------

df <- read.csv('thrice.df.csv', header = TRUE, stringsAsFactors = FALSE)

df <- df %>% 
  mutate(album = factor(album, levels = unique(album)),
         length = ms(length),
         lengthS = seconds(length))

wordToken <-  df %>%
  unnest_tokens(line, lyrics, token = stringr::str_split, pattern = ' <br>') %>%   
  unnest_tokens(word, line, to_lower = TRUE) 

countWord <- wordToken %>% count(word, sort=TRUE)

# Include stop_words ------------------------------------------------------

wordToken2 <- wordToken %>% 
  anti_join(stop_words) %>%                 
  arrange(ID)  # or track_num essentially same thing

countWord2 <- wordToken2 %>% count(word, sort=TRUE)

```


Let's get started!

```{r}
# Sentiment analysis ------------------------------------------------------

# using WORDTOKEN2 <<<

tidy_lyrics <- wordToken2 %>% 
  filter(!grepl('[0-9]', word)) %>% 
  left_join(get_sentiments("bing"), by = "word") %>% 
  group_by(album) %>%   
  mutate(linenumber = row_number(),
         sentiment = ifelse(is.na(sentiment), 'neutral', sentiment)) %>%   # add in neutral
  ungroup()

# Net sentiment ratio by album across time.
tidy_lyrics %>% 
  group_by(album) %>% 
  count(sentiment) %>% 
  spread(key = sentiment, value = n) %>%     # turn each sentiment into unique columns!!
  mutate(sentiment_ratio = (positive - negative) / (positive + negative + neutral)) 

```


```{r}
# total sentiment of every word (minus stop words) from all songs
tidy_lyrics %>% 
  count(sentiment)

```

Positive: 423, Negative: 912, Neutral: 5095

```{r}
# Net sentiment ratio for each song 
tidy_lyrics %>% 
  group_by(title, album) %>% 
  count(sentiment) %>% 
  spread(key = sentiment, value = n) %>% 
  mutate(sentiment_ratio = (positive - negative) / (positive + negative)) %>% 
  head(9)

```

NAs in some sentiment columns >>> convert to ZEROs...
# use replace_na() from the tidyr package!

```{r}

tidy_lyrics %>% 
  group_by(title, album) %>% 
  count(sentiment) %>% 
  spread(key = sentiment, value = n) %>% 
  replace_na(replace = list(negative = 0, neutral = 0, positive = 0)) %>%  # replace NAs with ZEROs!
  mutate(sentiment_ratio = (positive - negative) / (positive + negative)) %>% 
  head(9)

```

# now group by album!

```{r}

tidy_lyrics %>% 
  group_by(title, album) %>% 
  count(sentiment) %>% 
  spread(key = sentiment, value = n) %>% 
  replace_na(replace = list(negative = 0, neutral = 0, positive = 0)) %>%  # replace NAs with ZEROs!
  mutate(sentiment_ratio = (positive - negative) / (positive + negative)) %>% 
  group_by(album) %>% 
  summarize(mean_album = mean(sentiment_ratio))

```

# Lyrics sentiment ratio graph ####
# without neutral

```{r}

lyrics_sentiment <-  tidy_lyrics %>% 
  group_by(album, year) %>% 
  count(sentiment) %>% 
  spread(key = sentiment, value = n) %>% 
  replace_na(replace = list(negative = 0, neutral = 0, positive = 0)) %>%   
  # replace NAs with ZEROs!
  mutate(sentiment_ratio = (positive - negative) / (positive + negative)) %>% 
  # NO neutral in equation...
  select(album, year, sentiment_ratio)

library(hrbrthemes)

tidy_lyrics %>% 
  group_by(album, year) %>% 
  count(sentiment) %>% 
  spread(key = sentiment, value = n) %>% 
  replace_na(replace = list(negative = 0, neutral = 0, positive = 0)) %>%   
  # replace NAs with ZEROs!
  mutate(sentiment_ratio = (positive - negative) / (positive + negative + neutral)) %>% # neutral 
  select(album, year, sentiment_ratio) %>% 
  ggplot(aes(reorder(album, sentiment_ratio), sentiment_ratio)) + 
  geom_bar(stat = 'identity', fill = "darkgreen", alpha = 0.7) +  
  # aes(fill = sentiment_ratio > 0)   irrelevant as ALL negative...
  scale_fill_manual(guide = FALSE, values = c('#565b63', '#c40909')) +
  scale_y_percent(limits = c(-0.15, 0.10), breaks = pretty_breaks(7)) +    # from hrbrthemes
  theme_bw() +                     # from hrbrthemes
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 0.95)) +
  ggtitle("Lyrics Sentiment Ratio", 
          subtitle = "(Positive-Negative) / (Positive + Negative + Neutral)") +
  labs(x = "Albums", y = "Sentiment Ratio (%)")

```

# needs some work........    why negative? look at HOW negative is defined.
# negative talk but with positive action with negative undertones???? 

The Weight >>> showed "won't" used as positive
>>> investigate bi-grams and tri-grams

# Most common pos.neg words in THrice lyrics! ####

```{r}

word_count <- tidy_lyrics %>% 
  count(word, sentiment, sort = T) %>% 
  ungroup()

top_sentiments <-  word_count %>% 
  filter(sentiment != 'neutral') %>% 
  group_by(sentiment) %>% 
  top_n(5, wt = n) %>% 
  mutate(num = ifelse(sentiment == "negative", -n, n)) %>%  
  # count of negative words as negative #s!
  mutate(word = reorder(word, num)) %>% 
  select(word, sentiment, num)

# plot the occurences of the most common pos-neg words!

ggplot(top_sentiments, aes(reorder(word, num), num, fill = sentiment)) +
  geom_bar(stat = 'identity', alpha = 0.75) + 
  scale_fill_manual(guide = F, values = c("black", "darkgreen")) +
  scale_y_continuous(limits = c(-40, 70), breaks = pretty_breaks(12)) + 
  # c(-40, -25, -10, 0, 10, 25, 40, 55, 70)
  labs(y = "Number of Occurrences",
       x = '',
       title = 'Lyrics Sentiment of Thrice',
       subtitle = 'Most Common Positive and Negative Words') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 1.1))

```

# separate between negative and positive words
# order by number of occurences
# another way to visualize this is using a wordcloud!

# Word cloud: Most common Pos-Neg words in Thrice lyrics ####

```{r}
library(wordcloud)

tidy_lyrics %>% 
  filter(sentiment != 'neutral') %>% 
  count(word, sentiment, sort = T) %>% 
  reshape2::acast(word ~ sentiment, value.var = "n", fill = 0) %>% 
  comparison.cloud(colors = c("black", "darkgreen"), title.size = 1.5)

```

# LOVE appears most, free, faith, perfect, grace...
# FALL appears most, dead, burn, fear, sick...

# with nrc >>>>  Distribution of emotion words BOXPLOT: ####

```{r}

emotions_lyrics <- wordToken2 %>% 
  filter(!grepl('[0-9]', word)) %>%                  # because numbers cant have feelings
  left_join(get_sentiments("nrc"), by = "word") %>% 
  filter(!(sentiment == "negative" | sentiment == "positive")) %>% 
  mutate(sentiment = as.factor(sentiment)) %>% 
  group_by(album, sentiment) %>% 
  summarize(freq = n()) %>% 
  mutate(percent = freq / sum(freq)) %>%   # round()   *100
  select(-freq) %>% 
  ungroup() 

emotions_lyrics %>% 
  ggplot() +
  geom_boxplot(aes(x = reorder(sentiment, percent), y = percent, fill = sentiment)) +
  scale_y_percent() +
  theme_bw() +
  scale_fill_brewer(type = "qual", palette = "Set1") +
  ggtitle("Distribution of Emotion words, across all albums")

```

we can clearly see the box-plot distributions of the different emotion categories!
# black bar = mean, white circles = outliers

##### with bing >>>> only Pos-Neg-Neut BOXPLOT ####

```{r}

emotions_lyrics_bing <- wordToken2 %>% 
  filter(!grepl('[0-9]', word)) %>% 
  left_join(get_sentiments("bing"), by = "word") %>% 
  mutate(sentiment = ifelse(is.na(sentiment), 'neutral', sentiment)) %>%   
  # if use "bing", need to add in 'neutral' for all NOT pos/neg
  group_by(album, sentiment) %>% 
  summarize(freq = n()) %>% 
  mutate(percent = round(freq / sum(freq)*100)) %>% 
  select(-freq) %>% 
  ungroup() 

```

# try only Pos-Neg below...

```{r}

emotions_lyrics_bing %>% 
  filter(sentiment != "neutral") %>% 
  ggplot(aes(x = album, y = percent, color = sentiment, group = sentiment)) + 
  geom_line(size = 1) + 
  geom_point(size = 3) +
  xlab("Album") + ylab("Emotion Words Count (as %)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

# with NRC >>> ALL sentiments ####

```{r}

emotions_lyrics_nrc <- wordToken2 %>% 
  filter(!grepl('[0-9]', word)) %>% 
  left_join(get_sentiments("nrc"), by = "word") %>% 
  mutate(sentiment = ifelse(is.na(sentiment), 'neutral', sentiment)) %>%   
  # if use "bing", need to add in 'neutral' for all NOT pos/neg
  filter(sentiment != "neutral") %>% 
  group_by(album, sentiment) %>% 
  summarize(freq = n()) %>% 
  mutate(percent = round(freq / sum(freq)*100)) %>% 
  select(-freq) %>% 
  ungroup() 

# with all the sentiments = use nrc
ggplot(emotions_lyrics_nrc, aes(x = album, y = percent/100, color = sentiment, group = sentiment)) +   geom_line(size = 1) + 
  geom_point(size = 3) +
  scale_y_continuous(breaks = pretty_breaks(10), labels = percent_format()) +
  xlab("Album") + ylab("Proportion of Emotion Words") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank())

```

# Rather messy. no noticeable trends to be found...! 
# ALthough "fear" has started to creep up after AI:Fire outlier.
# also sudden dip in "anger" in AI: Earth as seen in previous plot!

```{r}
# ONLY positive-negative over time/album year...   ####
emotions_lyrics_nrc %>% 
  filter(sentiment == "positive" | sentiment == "negative") %>% 
  ggplot(aes(album, percent/100, color = sentiment, group = sentiment)) +
  geom_line(size = 1.5) +
  geom_point(size = 3.5) +
  scale_y_continuous(breaks = pretty_breaks(10), labels = percent_format()) +
  xlab("Album") + ylab("Proportion of Emotion Words") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank())

# huge spike in positive sentiment in AI: Earth???

```

Quite different from using BING lexicon...
arrange for comparison?

```{r}

bing_emotions <- emotions_lyrics_bing %>% 
  filter(sentiment != "neutral") %>% 
  ggplot(aes(x = album, y = percent, color = sentiment, group = sentiment)) + 
  geom_line(size = 1) + 
  geom_point(size = 3) +
  xlab("Album") + ylab("Emotion Words Count (as %)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

nrc_emotions <- emotions_lyrics_nrc %>% 
  filter(sentiment == "positive" | sentiment == "negative") %>% 
  ggplot(aes(album, percent/100, color = sentiment, group = sentiment)) +
  geom_line(size = 1.5) +
  geom_point(size = 3.5) +
  scale_y_continuous(breaks = pretty_breaks(10), labels = percent_format()) +
  xlab("Album") + ylab("Proportion of Emotion Words") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank())

library(gridExtra)
grid.arrange(bing_emotions, nrc_emotions, ncol = 2)

```

WHY SO DIFFERENCE!?!?!?!?!?!


```{r}
# NO pos or neg >>> anger, anticipation, disgust, fear, joy, sadness, surprise, trust

emotions_lyrics_nrc %>% 
  filter(sentiment != "positive" & sentiment != "negative") %>% 
  ggplot(aes(album, percent/100, color = sentiment, group = sentiment)) +
  geom_line(size = 1.5) +
  geom_point(size = 3.5) +
  scale_y_continuous(breaks = pretty_breaks(10), labels = percent_format()) +
  xlab("Album") + ylab("Proportion of Emotion Words") +
  ggtitle("Lyric Sentiments along Albums", subtitle = "From 2000-2016") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) 
  # scale_color_manual(sentiment ) #########

```

# AI: Earth spike in positive from large decrease in "anger", small increase in "joy"
# decrease in anticipation as well....

```{r}
# AI: Fire seems to have untrendly amount of FEAR: let's take a closer look!
nrcfear <- get_sentiments("nrc") %>% 
  filter(sentiment == "fear")

wordToken2 %>% 
  filter(album == "The Alchemy Index Fire") %>% 
  inner_join(nrcfear) %>% 
  count(word, sort = TRUE)
# FIRE being tagged as "fear" is what's mainly pushing up the trend
# fear, buried, die, gallows etc. are also in which is more in line with "fear" group


# AI: Earth    ???
nrcfear <- get_sentiments("nrc") %>% 
  filter(sentiment == "anger")

wordToken2 %>% 
  filter(album == "The Alchemy Index Earth") %>% 
  inner_join(nrcfear) %>% 
  count(word, sort = TRUE)

# appears only in 4 words!
# in other AI albums appear much more frequently!

# map
wordToken2 %>% 
  filter(album == "The Alchemy Index Air") %>% 
  inner_join(nrcfear) %>% 
  count(word, sort = TRUE)

wordToken2 %>% 
  filter(album == "The Alchemy Index Water") %>% 
  inner_join(nrcfear) %>% 
  count(word, sort = TRUE)

wordToken2 %>% 
  filter(album == "The Alchemy Index Fire") %>% 
  inner_join(nrcfear) %>% 
  count(word, sort = TRUE)

```



```{r}
#### Avg. emotion words expressed BAR chart + error: ####
overall_mean_sd <- emotions_lyrics_nrc %>% 
  group_by(sentiment) %>% 
  summarise(overall_mean = mean(percent/100), sd = sd(percent/100))  # percent to decimals




ggplot(overall_mean_sd, 
       aes(x = reorder(sentiment, -overall_mean), y = overall_mean)) +
  geom_bar(stat = "identity", fill = "darkgreen", alpha = 0.75) + 
  geom_errorbar(aes(ymin = overall_mean - sd, ymax = overall_mean + sd), 
                width = 0.2) +
  scale_y_continuous(breaks = pretty_breaks(), labels = percent_format()) +  # label as percentages
  xlab("Emotion Terms") +
  ylab("Emotion words count (%)") +
  ggtitle("Emotion words expressed in Thrice's lyrics") + 
  theme_bw() +
  theme(panel.grid.major.x = element_line(size = 1.25)) +
  coord_flip()
# error bars showing the 1 standard deviations from the mean on either side

```












```{r}
# Comparison Alchemy Index albums! ----------------------------------------

# Fire vs. Water
# Earth vs. Air

alchemy_index <- wordToken2 %>% 
  filter(str_detect(album, "The Alchemy Index")) %>% 
  select(title, album, year, word)

alchemy_index %>% 
  left_join(get_sentiments("nrc"), "word") %>% 
  mutate(sentiment = ifelse(is.na(sentiment), 'neutral', sentiment))

# to not clutter up global environment...
tidy_lyrics %>% 
  filter(str_detect(album, "The Alchemy Index")) %>% 
  select(title, album, year, word) %>% 
  left_join(get_sentiments("nrc"), "word") %>% 
  mutate(sentiment = ifelse(is.na(sentiment), 'neutral', sentiment)) %>% 
  filter(sentiment != "neutral") %>% 
  group_by(album, sentiment) %>% 
  summarize(freq = n()) %>% 
  mutate(percent = round(freq / sum(freq)*100)) %>% 
  select(-freq) %>% 
  ungroup() %>% 
  head(20)

# with neutral
tidy_lyrics %>% 
  filter(str_detect(album, "The Alchemy Index")) %>% 
  select(title, album, year, word) %>% 
  left_join(get_sentiments("nrc"), "word") %>% 
  mutate(sentiment = ifelse(is.na(sentiment), 'neutral', sentiment)) %>% 
  group_by(album, sentiment) %>% 
  summarize(freq = n()) %>% 
  mutate(percent = round(freq / sum(freq)*100)) %>% 
  select(-freq) %>% 
  ungroup() %>% 
  filter(sentiment != "neutral") %>% 
  filter(sentiment != "positive") %>% 
  filter(sentiment != "negative") %>% 
  ggplot(aes(x = album, y = percent/100, color = sentiment, group = sentiment)) + 
  geom_line(size = 1) + 
  geom_point(size = 3) +
  scale_y_continuous(breaks = pretty_breaks(10), labels = percent_format()) +
  xlab("Album") + ylab("Proportion of Emotion Words") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank())
# not informative... no timeline order of albums Fire or Water first? 
# ordering changes trends dramatically

```


